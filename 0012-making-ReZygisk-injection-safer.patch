From 0a5d15deafaae7a46f757374ba50dba8c9c8ba55 Mon Sep 17 00:00:00 2001
From: mistrmochov <matejdvoracek@fastmail.com>
Date: Tue, 5 Aug 2025 03:35:28 +0200
Subject: [PATCH 12/21] making ReZygisk injection safer

---
 native/src/core/daemon.rs                     |  2 +-
 native/src/core/rezygisk/rezygisk.rs          | 68 ++++++-------
 native/src/core/zygisk/daemon.rs              | 13 ---
 .../rustc-ice-2025-08-04T20_10_34-222417.txt  | 58 +++++++++++
 .../rustc-ice-2025-08-04T20_10_34-222419.txt  | 95 +++++++++++++++++++
 5 files changed, 183 insertions(+), 53 deletions(-)
 create mode 100644 native/src/rustc-ice-2025-08-04T20_10_34-222417.txt
 create mode 100644 native/src/rustc-ice-2025-08-04T20_10_34-222419.txt

diff --git a/native/src/core/daemon.rs b/native/src/core/daemon.rs
index d827d4a90..138baf0fd 100644
--- a/native/src/core/daemon.rs
+++ b/native/src/core/daemon.rs
@@ -11,7 +11,7 @@ use crate::logging::{android_logging, magisk_logging, setup_logfile, start_log_d
 use crate::module::remove_modules;
 use crate::package::ManagerInfo;
 use crate::resetprop::{get_prop, set_prop};
-use crate::rezygisk::{extract_rezygisk_to, install_rezygisk};
+use crate::rezygisk::{extract_rezygisk_to, hide_rezygisk, install_rezygisk, is_rezygisk};
 use crate::selinux::restore_tmpcon;
 use crate::socket::{IpcRead, IpcWrite};
 use crate::su::SuInfo;
diff --git a/native/src/core/rezygisk/rezygisk.rs b/native/src/core/rezygisk/rezygisk.rs
index cc5dfbd26..a65170900 100644
--- a/native/src/core/rezygisk/rezygisk.rs
+++ b/native/src/core/rezygisk/rezygisk.rs
@@ -1,5 +1,5 @@
 use base::{FsPathBuilder, ResultExt, Utf8CStr, cstr, info};
-use std::fs::{self, File, Permissions, remove_file};
+use std::fs::{self, File, Permissions};
 use std::io::Write;
 use std::os::unix::fs::PermissionsExt;
 use std::path::{Path, PathBuf};
@@ -9,10 +9,8 @@ static REZYGISK_ZIP: &[u8] = include_bytes!("rezygisk.zip");
 const UTIL_F: &str = include_str!("util_functions.sh");
 const MODULE_I: &str = include_str!("module_installer.sh");
 
-pub fn extract_rezygisk_to(path: &Path) -> std::io::Result<()> {
-    if path.exists() {
-        remove_file(path).log_ok();
-    }
+pub fn extract_rezygisk_to(path: &PathBuf) -> std::io::Result<()> {
+    remove_check(path)?;
     let mut file = File::create(path)?;
     file.write_all(REZYGISK_ZIP)?;
     Ok(())
@@ -21,26 +19,14 @@ pub fn extract_rezygisk_to(path: &Path) -> std::io::Result<()> {
 pub fn install_rezygisk(rezygisk_path: &Path, secure_dir: &Utf8CStr) -> std::io::Result<()> {
     let moduleroot = crate::consts::MODULEROOT;
     let zygisk_module = PathBuf::from(moduleroot).join("rezygisk");
-    if zygisk_module.exists() {
-        if zygisk_module.is_dir() {
-            fs::remove_dir_all(zygisk_module)?;
-        } else {
-            fs::remove_file(zygisk_module)?;
-        }
-    }
+    remove_check(&zygisk_module)?;
     let module_installer = PathBuf::from(secure_dir).join("magisk/module_installer.sh");
     let util_functions = PathBuf::from(secure_dir).join("magisk/util_functions.sh");
     if (rezygisk_path.exists() && rezygisk_path.is_file())
         && (util_functions.exists() && util_functions.is_file())
     {
         if !module_installer.exists() || !module_installer.is_file() {
-            if module_installer.exists() {
-                if module_installer.is_dir() {
-                    fs::remove_dir_all(&module_installer)?;
-                } else {
-                    fs::remove_file(&module_installer)?;
-                }
-            }
+            remove_check(&module_installer)?;
 
             fs::write(&module_installer, MODULE_I)?;
             fs::set_permissions(&module_installer, Permissions::from_mode(0o755))?;
@@ -60,18 +46,10 @@ pub fn install_rezygisk(rezygisk_path: &Path, secure_dir: &Utf8CStr) -> std::io:
 
         fs::write(&util_functions, util_functions_str)?;
 
-        if rezygisk_path.exists() {
-            fs::remove_file(rezygisk_path)?;
-        }
+        remove_check(&rezygisk_path.to_path_buf())?;
 
         let installed = PathBuf::from("/data/local/tmp/rezygisk");
-        if installed.exists() {
-            if installed.is_dir() {
-                fs::remove_dir_all(&installed)?;
-            } else {
-                fs::remove_file(&installed)?;
-            }
-        }
+        remove_check(&installed)?;
         File::create(installed)?;
     }
     Ok(())
@@ -97,15 +75,18 @@ pub fn hide_rezygisk() -> std::io::Result<()> {
         .join_path(moduleroot)
         .join_path("rezygisk/module.prop");
     if module_prop.exists() {
-        module_prop.unmount().log_ok();
-    }
-    if rezygisk_dir.exists() {
-        if rezygisk_dir.is_dir() {
-            fs::remove_dir_all(rezygisk_dir)?;
-        } else {
-            fs::remove_file(rezygisk_dir)?;
+        let mut millis = 0;
+        while !module_prop.unmount().is_ok() {
+            millis += 100;
+            if millis >= 20000 {
+                info!("rezygisk: failed to unmount \'{}\'\n", module_prop);
+                break;
+            }
+            std::thread::sleep(std::time::Duration::from_millis(100));
         }
+        //module_prop.unmount().log_ok();
     }
+    remove_check(&rezygisk_dir)?;
     Ok(())
 }
 
@@ -113,8 +94,17 @@ pub fn is_rezygisk() -> bool {
     let rezygisk = PathBuf::from(crate::consts::MODULEROOT).join("rezygisk");
     let installed = PathBuf::from("/data/local/tmp/rezygisk");
     let exists = rezygisk.exists() && (installed.exists() && installed.is_file());
-    if installed.exists() && installed.is_file() {
-        fs::remove_file(installed).log_ok();
-    }
+    remove_check(&installed).log_ok();
     exists
 }
+
+pub fn remove_check(file: &PathBuf) -> std::io::Result<()> {
+    if file.exists() {
+        if file.is_dir() {
+            fs::remove_dir_all(file.clone())?;
+        } else {
+            fs::remove_file(file.clone())?;
+        }
+    }
+    Ok(())
+}
diff --git a/native/src/core/zygisk/daemon.rs b/native/src/core/zygisk/daemon.rs
index 212b69028..c771b3cff 100644
--- a/native/src/core/zygisk/daemon.rs
+++ b/native/src/core/zygisk/daemon.rs
@@ -179,12 +179,6 @@ impl MagiskD {
 
     pub fn zygisk_reset(&self, mut restore: bool) {
         if !self.zygisk_enabled.load(Ordering::Acquire) {
-            if is_rezygisk() {
-                self.set_db_setting(DbEntryKey::ZygiskConfig, 1).log_ok();
-                std::thread::spawn(|| {
-                    hide_rezygisk().log_ok();
-                });
-            }
             return;
         }
 
@@ -201,13 +195,6 @@ impl MagiskD {
         if restore {
             restore_zygisk_prop();
         }
-
-        if is_rezygisk() {
-            self.set_db_setting(DbEntryKey::ZygiskConfig, 1).log_ok();
-            std::thread::spawn(|| {
-                hide_rezygisk().log_ok();
-            });
-        }
     }
 
     fn get_module_fds(&self, is_64_bit: bool) -> Option<Vec<RawFd>> {
diff --git a/native/src/rustc-ice-2025-08-04T20_10_34-222417.txt b/native/src/rustc-ice-2025-08-04T20_10_34-222417.txt
new file mode 100644
index 000000000..f469082f9
--- /dev/null
+++ b/native/src/rustc-ice-2025-08-04T20_10_34-222417.txt
@@ -0,0 +1,58 @@
+thread 'rustc' panicked at compiler/rustc_hir_typeck/src/gather_locals.rs:112:17:
+assertion `left == right` failed
+  left: Some(?41t)
+ right: None
+stack backtrace:
+   0:     0x7fa9017eaf15 - <unknown>
+   1:     0x7fa9017eae65 - std::backtrace::Backtrace::force_capture::h961d70de3979b913
+   2:     0x7fa8ff3dbffe - <unknown>
+   3:     0x7fa90180ac43 - std::panicking::rust_panic_with_hook::h109190f8d372c737
+   4:     0x7fa90180a91a - <unknown>
+   5:     0x7fa901805869 - <unknown>
+   6:     0x7fa90180a5cd - __rustc[be226b61905624c6]::rust_begin_unwind
+   7:     0x7fa8fe6603e0 - core::panicking::panic_fmt::h1cd0eaa52d6cf955
+   8:     0x7fa8fe6608d5 - core::panicking::assert_failed_inner::h35de2bc836aa2b8f
+   9:     0x7fa90133b27b - core[d94f0789129b4270]::panicking::assert_failed::<core[d94f0789129b4270]::option::Option<rustc_middle[6987e185c8237ec8]::ty::Ty>, core[d94f0789129b4270]::option::Option<rustc_middle[6987e185c8237ec8]::ty::Ty>>
+  10:     0x7fa8ffb66ea5 - <unknown>
+  11:     0x7fa8ffb4483e - <unknown>
+  12:     0x7fa8ffaf718e - <unknown>
+  13:     0x7fa8ffba7aa8 - <unknown>
+  14:     0x7fa8ffbf5f70 - <unknown>
+  15:     0x7fa8ffaf718e - <unknown>
+  16:     0x7fa8ffb34267 - <unknown>
+  17:     0x7fa8ffad1754 - <unknown>
+  18:     0x7fa8ffc0209a - <unknown>
+  19:     0x7fa8ffaf718e - <unknown>
+  20:     0x7fa8ffb44a91 - <unknown>
+  21:     0x7fa8ffaf718e - <unknown>
+  22:     0x7fa8ffaf9a50 - <unknown>
+  23:     0x7fa8ffbe2d5a - <unknown>
+  24:     0x7fa8ffc34c7b - <unknown>
+  25:     0x7fa8ffbde91d - rustc_hir_typeck[b408f2bb4a2aebb2]::typeck
+  26:     0x7fa900dd5f47 - <unknown>
+  27:     0x7fa900bff970 - rustc_query_system[a9727abd061ed217]::query::plumbing::try_execute_query::<rustc_query_impl[3ab70ac72cdd8c97]::DynamicConfig<rustc_data_structures[8c353c39a5a0e88e]::vec_cache::VecCache<rustc_span[ffa1d53b09691984]::def_id::LocalDefId, rustc_middle[6987e185c8237ec8]::query::erase::Erased<[u8; 8usize]>, rustc_query_system[a9727abd061ed217]::dep_graph::graph::DepNodeIndex>, false, false, false>, rustc_query_impl[3ab70ac72cdd8c97]::plumbing::QueryCtxt, true>
+  28:     0x7fa900e04be2 - <unknown>
+  29:     0x7fa8ff6e67a2 - <unknown>
+  30:     0x7fa8ff889b30 - rustc_hir_analysis[3d08fb4bce08ca84]::check_crate
+  31:     0x7fa8ffe6f859 - <unknown>
+  32:     0x7fa8ffe72a6e - rustc_interface[17e8c035ce58f434]::passes::analysis
+  33:     0x7fa900dd5f97 - <unknown>
+  34:     0x7fa900b662d7 - rustc_query_system[a9727abd061ed217]::query::plumbing::try_execute_query::<rustc_query_impl[3ab70ac72cdd8c97]::DynamicConfig<rustc_query_system[a9727abd061ed217]::query::caches::SingleCache<rustc_middle[6987e185c8237ec8]::query::erase::Erased<[u8; 0usize]>>, false, false, false>, rustc_query_impl[3ab70ac72cdd8c97]::plumbing::QueryCtxt, true>
+  35:     0x7fa900de2ef4 - <unknown>
+  36:     0x7fa8ff387fa5 - <unknown>
+  37:     0x7fa8ff3d7f18 - <unknown>
+  38:     0x7fa8ff3c6df6 - <unknown>
+  39:     0x7fa8ff3e0784 - <unknown>
+  40:     0x7fa90180e44b - <unknown>
+  41:     0x7fa8fd0969cb - <unknown>
+  42:     0x7fa8fd11aa4c - <unknown>
+  43:                0x0 - <unknown>
+
+
+rustc version: 1.88.0-nightly (6b00bc388 2025-06-23)
+platform: x86_64-unknown-linux-gnu
+
+query stack during panic:
+#0 [typeck] type-checking `daemon::<impl at core/daemon.rs:80:1: 80:13>::boot_complete`
+#1 [analysis] running analysis passes on this crate
+end of query stack
diff --git a/native/src/rustc-ice-2025-08-04T20_10_34-222419.txt b/native/src/rustc-ice-2025-08-04T20_10_34-222419.txt
new file mode 100644
index 000000000..0af3d86e8
--- /dev/null
+++ b/native/src/rustc-ice-2025-08-04T20_10_34-222419.txt
@@ -0,0 +1,95 @@
+thread 'rustc' panicked at compiler/rustc_hir_typeck/src/gather_locals.rs:112:17:
+assertion `left == right` failed
+  left: Some(?41t)
+ right: None
+stack backtrace:
+   0:     0x7f1297deaf15 - <unknown>
+   1:     0x7f1297deae65 - std::backtrace::Backtrace::force_capture::h961d70de3979b913
+   2:     0x7f12959dbffe - <unknown>
+   3:     0x7f1297e0ac43 - std::panicking::rust_panic_with_hook::h109190f8d372c737
+   4:     0x7f1297e0a91a - <unknown>
+   5:     0x7f1297e05869 - <unknown>
+   6:     0x7f1297e0a5cd - __rustc[be226b61905624c6]::rust_begin_unwind
+   7:     0x7f1294c603e0 - core::panicking::panic_fmt::h1cd0eaa52d6cf955
+   8:     0x7f1294c608d5 - core::panicking::assert_failed_inner::h35de2bc836aa2b8f
+   9:     0x7f129793b27b - core[d94f0789129b4270]::panicking::assert_failed::<core[d94f0789129b4270]::option::Option<rustc_middle[6987e185c8237ec8]::ty::Ty>, core[d94f0789129b4270]::option::Option<rustc_middle[6987e185c8237ec8]::ty::Ty>>
+  10:     0x7f1296166ea5 - <unknown>
+  11:     0x7f129614483e - <unknown>
+  12:     0x7f12960f718e - <unknown>
+  13:     0x7f12961a7aa8 - <unknown>
+  14:     0x7f12961f5f70 - <unknown>
+  15:     0x7f12960f718e - <unknown>
+  16:     0x7f1296134267 - <unknown>
+  17:     0x7f12960d1754 - <unknown>
+  18:     0x7f129620209a - <unknown>
+  19:     0x7f12960f718e - <unknown>
+  20:     0x7f1296144a91 - <unknown>
+  21:     0x7f12960f718e - <unknown>
+  22:     0x7f12960f9a50 - <unknown>
+  23:     0x7f12961e2d5a - <unknown>
+  24:     0x7f1296234c7b - <unknown>
+  25:     0x7f12961de91d - rustc_hir_typeck[b408f2bb4a2aebb2]::typeck
+  26:     0x7f12973d5f47 - <unknown>
+  27:     0x7f12971ff970 - rustc_query_system[a9727abd061ed217]::query::plumbing::try_execute_query::<rustc_query_impl[3ab70ac72cdd8c97]::DynamicConfig<rustc_data_structures[8c353c39a5a0e88e]::vec_cache::VecCache<rustc_span[ffa1d53b09691984]::def_id::LocalDefId, rustc_middle[6987e185c8237ec8]::query::erase::Erased<[u8; 8usize]>, rustc_query_system[a9727abd061ed217]::dep_graph::graph::DepNodeIndex>, false, false, false>, rustc_query_impl[3ab70ac72cdd8c97]::plumbing::QueryCtxt, true>
+  28:     0x7f1297404be2 - <unknown>
+  29:     0x7f1295ce67a2 - <unknown>
+  30:     0x7f1295e89b30 - rustc_hir_analysis[3d08fb4bce08ca84]::check_crate
+  31:     0x7f129646f859 - <unknown>
+  32:     0x7f1296472a6e - rustc_interface[17e8c035ce58f434]::passes::analysis
+  33:     0x7f12973d5f97 - <unknown>
+  34:     0x7f12971662d7 - rustc_query_system[a9727abd061ed217]::query::plumbing::try_execute_query::<rustc_query_impl[3ab70ac72cdd8c97]::DynamicConfig<rustc_query_system[a9727abd061ed217]::query::caches::SingleCache<rustc_middle[6987e185c8237ec8]::query::erase::Erased<[u8; 0usize]>>, false, false, false>, rustc_query_impl[3ab70ac72cdd8c97]::plumbing::QueryCtxt, true>
+  35:     0x7f12973e2ef4 - <unknown>
+  36:     0x7f1295987fa5 - <unknown>
+  37:     0x7f12959d7f18 - <unknown>
+  38:     0x7f12959c6df6 - <unknown>
+  39:     0x7f12959e0784 - <unknown>
+  40:     0x7f1297e0e44b - <unknown>
+  41:     0x7f12936969cb - <unknown>
+  42:     0x7f129371aa4c - <unknown>
+  43:                0x0 - <unknown>
+
+
+rustc version: 1.88.0-nightly (6b00bc388 2025-06-23)
+platform: x86_64-unknown-linux-gnu
+
+query stack during panic:
+#0 [typeck] type-checking `daemon::<impl at core/daemon.rs:80:1: 80:13>::boot_complete`
+#1 [analysis] running analysis passes on this crate
+end of query stack
+delayed bug: this path really should be doomed...
+   0: <unknown>
+   1: <rustc_errors::DiagCtxtHandle>::emit_diagnostic
+   2: <rustc_span::ErrorGuaranteed as rustc_errors::diagnostic::EmissionGuarantee>::emit_producing_guarantee
+   3: <unknown>
+   4: <unknown>
+   5: <unknown>
+   6: <unknown>
+   7: <unknown>
+   8: <unknown>
+   9: <unknown>
+  10: <unknown>
+  11: <unknown>
+  12: <unknown>
+  13: <unknown>
+  14: <unknown>
+  15: <unknown>
+  16: <unknown>
+  17: rustc_hir_typeck::typeck
+  18: <unknown>
+  19: rustc_query_system::query::plumbing::try_execute_query::<rustc_query_impl::DynamicConfig<rustc_data_structures::vec_cache::VecCache<rustc_span::def_id::LocalDefId, rustc_middle::query::erase::Erased<[u8; 8]>, rustc_query_system::dep_graph::graph::DepNodeIndex>, false, false, false>, rustc_query_impl::plumbing::QueryCtxt, true>
+  20: <unknown>
+  21: <unknown>
+  22: rustc_hir_analysis::check_crate
+  23: <unknown>
+  24: rustc_interface::passes::analysis
+  25: <unknown>
+  26: rustc_query_system::query::plumbing::try_execute_query::<rustc_query_impl::DynamicConfig<rustc_query_system::query::caches::SingleCache<rustc_middle::query::erase::Erased<[u8; 0]>>, false, false, false>, rustc_query_impl::plumbing::QueryCtxt, true>
+  27: <unknown>
+  28: <unknown>
+  29: <unknown>
+  30: <unknown>
+  31: <unknown>
+  32: <unknown>
+  33: <unknown>
+  34: <unknown>
+
-- 
2.52.0

