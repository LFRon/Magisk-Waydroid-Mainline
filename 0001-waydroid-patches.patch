From f070be0298df1af20f2ea4094dd8d757559fef9f Mon Sep 17 00:00:00 2001
From: mistrmochov <matejdvoracek@fastmail.com>
Date: Sun, 13 Jul 2025 23:39:41 +0200
Subject: [PATCH 01/21] waydroid patches ^^

---
 .../topjohnwu/magisk/ui/home/HomeViewModel.kt |  3 ++-
 native/src/base/files.rs                      | 22 -------------------
 native/src/core/.vscode/settings.json         |  6 +++++
 3 files changed, 8 insertions(+), 23 deletions(-)
 create mode 100644 native/src/core/.vscode/settings.json

diff --git a/app/apk/src/main/java/com/topjohnwu/magisk/ui/home/HomeViewModel.kt b/app/apk/src/main/java/com/topjohnwu/magisk/ui/home/HomeViewModel.kt
index a82b6cc20..f903c0b7d 100644
--- a/app/apk/src/main/java/com/topjohnwu/magisk/ui/home/HomeViewModel.kt
+++ b/app/apk/src/main/java/com/topjohnwu/magisk/ui/home/HomeViewModel.kt
@@ -6,6 +6,7 @@ import android.content.Intent
 import android.widget.Toast
 import androidx.core.net.toUri
 import androidx.databinding.Bindable
+import android.util.Log
 import com.topjohnwu.magisk.BR
 import com.topjohnwu.magisk.R
 import com.topjohnwu.magisk.arch.ActivityExecutor
@@ -151,7 +152,7 @@ class HomeViewModel(
         if (magiskState == State.INVALID || checkedEnv) return
         val cmd = "env_check ${Info.env.versionString} ${Info.env.versionCode}"
         val code = Shell.cmd(cmd).await().code
-        if (code != 0) {
+        if (code != 0 && code != 2) {
             EnvFixDialog(this, code).show()
         }
         checkedEnv = true
diff --git a/native/src/base/files.rs b/native/src/base/files.rs
index fcc2891f3..f3f8fb5ef 100644
--- a/native/src/base/files.rs
+++ b/native/src/base/files.rs
@@ -299,8 +299,6 @@ impl Utf8CStr {
             #[cfg(feature = "selinux")]
             con: cstr::buf::new(),
         };
-        #[cfg(feature = "selinux")]
-        self.get_secontext(&mut attr.con)?;
         Ok(attr)
     }
 
@@ -322,11 +320,6 @@ impl Utf8CStr {
                 None,
             )?;
         }
-
-        #[cfg(feature = "selinux")]
-        if !attr.con.is_empty() {
-            self.set_secontext(&attr.con)?;
-        }
         Ok(())
     }
 
@@ -539,8 +532,6 @@ impl FsPathFollow {
             #[cfg(feature = "selinux")]
             con: cstr::buf::new(),
         };
-        #[cfg(feature = "selinux")]
-        self.get_secontext(&mut attr.con)?;
         Ok(attr)
     }
 
@@ -553,11 +544,6 @@ impl FsPathFollow {
             Some(Gid::from(attr.st.st_gid)),
         )
         .check_os_err("chown", Some(self), None)?;
-
-        #[cfg(feature = "selinux")]
-        if !attr.con.is_empty() {
-            self.set_secontext(&attr.con)?;
-        }
         Ok(())
     }
 
@@ -654,9 +640,6 @@ pub fn fd_get_attr(fd: RawFd) -> OsResult<'static, FileAttr> {
     let mut attr = FileAttr::new();
     unsafe {
         libc::fstat(fd, &mut attr.st).check_os_err("fstat", None, None)?;
-
-        #[cfg(feature = "selinux")]
-        fd_get_secontext(fd, &mut attr.con)?;
     }
     Ok(attr)
 }
@@ -665,11 +648,6 @@ pub fn fd_set_attr(fd: RawFd, attr: &FileAttr) -> OsResult<'_, ()> {
     unsafe {
         libc::fchmod(fd, (attr.st.st_mode & 0o777).as_()).check_os_err("fchmod", None, None)?;
         libc::fchown(fd, attr.st.st_uid, attr.st.st_gid).check_os_err("fchown", None, None)?;
-
-        #[cfg(feature = "selinux")]
-        if !attr.con.is_empty() {
-            fd_set_secontext(fd, &attr.con)?;
-        }
     }
     Ok(())
 }
diff --git a/native/src/core/.vscode/settings.json b/native/src/core/.vscode/settings.json
new file mode 100644
index 000000000..6931b6673
--- /dev/null
+++ b/native/src/core/.vscode/settings.json
@@ -0,0 +1,6 @@
+{
+    "files.associations": {
+        "ranges": "cpp",
+        "string_view": "cpp"
+    }
+}
\ No newline at end of file
-- 
2.52.0

