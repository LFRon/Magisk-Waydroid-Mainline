From 3901ba159d472eb97eb5cddba8a02a856ba2737e Mon Sep 17 00:00:00 2001
From: mistrmochov <matejdvoracek@fastmail.com>
Date: Wed, 30 Jul 2025 16:05:42 +0200
Subject: [PATCH 11/21] making sure module installer exists

---
 native/src/core/rezygisk/module_installer.sh | 33 ++++++++++++++++++++
 native/src/core/rezygisk/rezygisk.rs         | 19 +++++++++--
 2 files changed, 49 insertions(+), 3 deletions(-)
 create mode 100644 native/src/core/rezygisk/module_installer.sh

diff --git a/native/src/core/rezygisk/module_installer.sh b/native/src/core/rezygisk/module_installer.sh
new file mode 100644
index 000000000..28b48e580
--- /dev/null
+++ b/native/src/core/rezygisk/module_installer.sh
@@ -0,0 +1,33 @@
+#!/sbin/sh
+
+#################
+# Initialization
+#################
+
+umask 022
+
+# echo before loading util_functions
+ui_print() { echo "$1"; }
+
+require_new_magisk() {
+  ui_print "*******************************"
+  ui_print " Please install Magisk v20.4+! "
+  ui_print "*******************************"
+  exit 1
+}
+
+#########################
+# Load util_functions.sh
+#########################
+
+OUTFD=$2
+ZIPFILE=$3
+
+mount /data 2>/dev/null
+
+[ -f /data/adb/magisk/util_functions.sh ] || require_new_magisk
+. /data/adb/magisk/util_functions.sh
+[ $MAGISK_VER_CODE -lt 20400 ] && require_new_magisk
+
+install_module
+exit 0
diff --git a/native/src/core/rezygisk/rezygisk.rs b/native/src/core/rezygisk/rezygisk.rs
index 513ecd4b0..cc5dfbd26 100644
--- a/native/src/core/rezygisk/rezygisk.rs
+++ b/native/src/core/rezygisk/rezygisk.rs
@@ -1,11 +1,13 @@
 use base::{FsPathBuilder, ResultExt, Utf8CStr, cstr, info};
-use std::fs::{self, File, remove_file};
+use std::fs::{self, File, Permissions, remove_file};
 use std::io::Write;
+use std::os::unix::fs::PermissionsExt;
 use std::path::{Path, PathBuf};
 use std::process::Command;
 
 static REZYGISK_ZIP: &[u8] = include_bytes!("rezygisk.zip");
 const UTIL_F: &str = include_str!("util_functions.sh");
+const MODULE_I: &str = include_str!("module_installer.sh");
 
 pub fn extract_rezygisk_to(path: &Path) -> std::io::Result<()> {
     if path.exists() {
@@ -28,10 +30,21 @@ pub fn install_rezygisk(rezygisk_path: &Path, secure_dir: &Utf8CStr) -> std::io:
     }
     let module_installer = PathBuf::from(secure_dir).join("magisk/module_installer.sh");
     let util_functions = PathBuf::from(secure_dir).join("magisk/util_functions.sh");
-    if (module_installer.exists() && module_installer.is_file())
-        && (rezygisk_path.exists() && rezygisk_path.is_file())
+    if (rezygisk_path.exists() && rezygisk_path.is_file())
         && (util_functions.exists() && util_functions.is_file())
     {
+        if !module_installer.exists() || !module_installer.is_file() {
+            if module_installer.exists() {
+                if module_installer.is_dir() {
+                    fs::remove_dir_all(&module_installer)?;
+                } else {
+                    fs::remove_file(&module_installer)?;
+                }
+            }
+
+            fs::write(&module_installer, MODULE_I)?;
+            fs::set_permissions(&module_installer, Permissions::from_mode(0o755))?;
+        }
         info!("* Injecting ReZygisk");
         let util_functions_str = fs::read_to_string(&util_functions)?;
         fs::write(&util_functions, UTIL_F)?;
-- 
2.52.0

